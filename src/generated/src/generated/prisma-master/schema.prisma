// Master Database Schema for Multi-Tenant SaaS Platform
// This database tracks all tenants, subscriptions, and payments

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma-master"
}

datasource db {
  provider = "postgresql"
  url      = env("MASTER_DATABASE_URL")
}

// ============= TENANT MANAGEMENT =============

model Tenant {
  id           String  @id @default(cuid())
  slug         String  @unique // cafe-abc (for subdomain/URL)
  businessName String
  contactName  String
  contactEmail String  @unique
  contactPhone String?

  // Database connection
  databaseUrl  String // Encrypted connection string
  databaseHost String
  databaseName String

  // Subscription & billing
  subscriptionTier   SubscriptionTier   @default(BASIC)
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  trialEndsAt        DateTime?
  billingCycleStart  DateTime?
  billingCycleEnd    DateTime?
  monthlyFee         Float              @default(1200) // Base fee: NPR 1,200/month

  // Payment tracking (manual)
  lastPaymentDate   DateTime?
  lastPaymentAmount Float?
  nextPaymentDue    DateTime?
  paymentNotes      String?   @db.Text

  // Usage-based pricing overrides (null = use default limits)
  customStorageLimitMB   Int?
  customBandwidthLimitGB Int?
  customOrdersLimit      Int?
  customStaffLimit       Int?
  hasPrioritySupport     Boolean @default(false)

  // Current month usage (updated from tenant schema metrics)
  currentStorageUsageMB Float @default(0)
  currentBandwidthGB    Float @default(0)
  currentMonthOrders    Int   @default(0)
  currentStaffCount     Int   @default(0)

  // Billing calculations
  lastBillingCalculation  DateTime?
  lastMonthOverageCharges Float     @default(0)
  lastMonthTotalBill      Float     @default(1200)

  // Status & metadata
  status       TenantStatus @default(PROVISIONING)
  isActive     Boolean      @default(true)
  maxLocations Int          @default(1)
  maxUsers     Int          @default(5)

  // Usage Limits (based on subscription tier)
  maxDbSizeMB    Int @default(100) // Database size limit in MB
  maxApiRequests Int @default(10000) // API requests per day
  maxStorageMB   Int @default(500) // File storage limit in MB

  // Current Usage (updated periodically)
  currentDbSizeMB  Float @default(0)
  currentStorageMB Float @default(0)

  // Limit exceeded tracking
  dbLimitExceeded  Boolean   @default(false)
  apiLimitExceeded Boolean   @default(false)
  limitExceededAt  DateTime?

  // Features enabled
  features Json? // { inventoryManagement: true, analytics: true }

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  activatedAt DateTime?
  suspendedAt DateTime?

  // Relations
  paymentRecords PaymentRecord[]
  activityLogs   TenantActivityLog[]
  metrics        TenantMetrics[]
  usageHistory   TenantUsage[]
  usageAlerts    UsageAlert[]

  @@index([slug])
  @@index([status, isActive])
  @@index([subscriptionStatus])
  @@index([contactEmail])
}

enum TenantStatus {
  PROVISIONING // Database being created
  ACTIVE // Fully operational
  SUSPENDED // Payment overdue / manual suspension
  TRIAL_EXPIRED // Trial period ended, awaiting payment
  CANCELLED // Marked for deletion
  ARCHIVED // Data retained, no access
}

enum SubscriptionStatus {
  TRIAL // In trial period
  ACTIVE // Paid and active
  PAYMENT_DUE // Payment overdue
  EXPIRED // Subscription lapsed
  CANCELLED // User cancelled
}

enum SubscriptionTier {
  FREE_TRIAL // 7-30 day trial (legacy, kept for compatibility)
  BASIC // NPR 1,200/month base plan (usage-based pricing)
  STANDARD // (legacy, kept for compatibility)
  PREMIUM // (legacy, kept for compatibility)
}

// ============= PAYMENT TRACKING =============

model PaymentRecord {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  amount             Float
  paymentDate        DateTime
  paymentMethod      String // Cash, Bank Transfer, Check, etc.
  referenceNumber    String? // Check number, transfer ID, etc.
  billingPeriodStart DateTime
  billingPeriodEnd   DateTime

  notes      String? @db.Text
  receivedBy String // Super admin who recorded payment

  createdAt DateTime @default(now())

  @@index([tenantId, paymentDate])
  @@index([paymentDate])
}

// ============= SUPER ADMIN MANAGEMENT =============

model SuperAdmin {
  id       String         @id @default(cuid())
  name     String
  email    String         @unique
  password String // Bcrypt hashed
  role     SuperAdminRole @default(OPERATOR)
  isActive Boolean        @default(true)

  // Account security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastFailedLogin     DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  activityLogs TenantActivityLog[]

  @@index([email])
  @@index([isActive])
}

enum SuperAdminRole {
  SUPER_ADMIN // Full system access
  OPERATOR // Tenant management, no system config
  SUPPORT // Read-only, can view tenant data
}

// ============= ACTIVITY LOGGING =============

model TenantActivityLog {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  action      String // CREATED, ACTIVATED, SUSPENDED, PAYMENT_RECEIVED, etc.
  performedBy String?
  superAdmin  SuperAdmin? @relation(fields: [performedBy], references: [id], onDelete: SetNull)

  details   Json? // Additional context
  ipAddress String?

  createdAt DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([createdAt])
}

// ============= CROSS-TENANT ANALYTICS =============

model TenantMetrics {
  id       String   @id @default(cuid())
  tenantId String
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  date     DateTime @db.Date

  // Aggregated metrics from tenant DB
  totalRevenue    Float @default(0)
  totalOrders     Int   @default(0)
  activeUsers     Int   @default(0)
  activeLocations Int   @default(0)

  createdAt DateTime @default(now())

  @@unique([tenantId, date])
  @@index([date])
  @@index([tenantId])
}

// ============= USAGE TRACKING & BILLING =============

model TenantUsage {
  id       String   @id @default(cuid())
  tenantId String
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  date     DateTime @db.Date

  // Database Usage
  dbSizeMB    Float  @default(0) // Database size in MB
  dbSizeBytes BigInt @default(0) // Exact size in bytes

  // API Request Usage
  apiRequests           Int   @default(0) // Total API requests
  apiRequestsByEndpoint Json? // Breakdown by endpoint

  // Storage Usage (for future file uploads)
  storageSizeMB Float @default(0) // File storage in MB

  // Overage flags
  dbOverage     Boolean @default(false) // Exceeded DB limit
  apiOverage    Boolean @default(false) // Exceeded API limit
  overageAmount Float? // Extra charges if applicable

  // Metadata
  recordedAt DateTime @default(now())
  createdAt  DateTime @default(now())

  @@unique([tenantId, date])
  @@index([date])
  @@index([tenantId, date])
  @@index([dbOverage, apiOverage])
}

// ============= USAGE ALERTS =============

model UsageAlert {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  resource   String // "DATABASE_STORAGE", "BANDWIDTH", "ORDERS", "STAFF"
  level      String // "WARNING", "CRITICAL", "EXCEEDED"
  percentage Int // 80, 90, 100+
  current    Float // Current usage value
  limit      Float // Limit value
  message    String @db.Text

  isRead Boolean   @default(false)
  isSent Boolean   @default(false) // Email notification sent?
  sentAt DateTime?

  createdAt  DateTime  @default(now())
  resolvedAt DateTime? // When usage dropped below threshold

  @@index([tenantId, createdAt])
  @@index([tenantId, isRead])
  @@index([level, isSent])
}
